#!/bin/bash


ASG_NAME="mrcnn_benchmark_EFA_300"
INSTANCES=$(aws autoscaling describe-auto-scaling-instances --output text | grep $ASG_NAME | awk '{print $5}' | grep "i-" | sort -u)

HOSTFILE=mpihosts.txt

# clear out hosts file
if [ -f $HOSTFILE ]; then
	echo "Removing existing hosts file."
	rm -f $HOSTFILE
fi

for instanceId in $INSTANCES; do
	echo -n "Setting up instance $instanceId..."
	public_ip=$(aws ec2 describe-instances --filters Name=instance-id,Values=${instanceId} --output text | grep ASSOCIATION | awk '{print $4}' | head -1)
	private_ip=$(aws ec2 describe-instances --filters Name=instance-id,Values=${instanceId} --output text | grep PRIVATEIPADDRESSES | awk '{print $4}' | head -1)
	echo "public_ip=$public_ip,private_ip=$private_ip "
	echo $private_ip >> $HOSTFILE
done

